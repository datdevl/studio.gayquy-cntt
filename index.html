<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./lg.jpg" type="image/png">
    <title>Studio G√¢y Qu·ªπ  ‚Äî FauTaubooth </title>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=DM+Serif+Display:ital@0;1&family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        button.loading-btn { position: relative; pointer-events: none; opacity: 0.7; }
        button.loading-btn::after { content: ""; position: absolute; top: 50%; left: 50%; width: 18px; height: 18px; border: 3px solid transparent; border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; transform: translate(-50%, -50%); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: linear-gradient(180deg, rgba(15,15,18,0.25), rgba(15,15,18,0.25)),
                        url('./lg.jpg') left center / 50% 100% no-repeat,
                        url('./lg.jpg') right center / 50% 100% no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: #eaeaf2;
            line-height: 1.6;
        }
        h1 { font-family: 'Andale Mono', monospace; font-weight: 700; font-size: clamp(2em, 5.5vw, 3.6em); color: #ffffff; letter-spacing: 0.6px; margin-bottom: 12px; text-shadow: 0 2px 8px rgba(0,0,0,0.35); animation: fadeInDown 0.8s ease-out; }
        .brand { display: flex; align-items: center; gap: 14px; }
        .logo { width: 56px; height: 56px; object-fit: cover; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 12px 28px rgba(0,0,0,0.35); }
        @media (max-width: 768px) { .logo { width: 44px; height: 44px; } }
        p.intro { font-size: 1.05em; color: #fff; margin-bottom: 28px; opacity: 0.92; letter-spacing: 0.2px; font-weight: 400; animation: fadeInUp 1s ease-out 0.5s both; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.12);
            animation: fadeIn 0.8s ease-out;
        }
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.25);
            border-radius: 16px;
            padding: 32px;
            margin: 30px 0;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        .upload-area:hover { border-color: #f5576c; transform: scale(1.01); }
        .upload-area.dragging { border-color: #8a8aff; transform: scale(1.02); }
        .upload-area::before { content: 'üì∏'; font-size: 2.4em; display: block; margin-bottom: 10px; }
        input[type="file"] { display: none; }
        .preview { max-width: 100%; max-height: 600px; border-radius: 16px; margin: 18px auto; display: none; box-shadow: 0 18px 40px rgba(0,0,0,0.25); object-fit: contain; }
        button {
            background: linear-gradient(135deg, #f5576c, #6c7cff);
            color: #fff;
            border: 0;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 5px;
            transition: all 0.18s ease;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,0.22); }
        button:disabled { background: #656b7a; cursor: not-allowed; }
        #resetBtn, #nextSetBtn { background: #6c757d !important; }
        #setInfo { font-weight: bold; color: #f5576c; margin: 10px 0; }
        .filters-grid, .frames-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 30px 0; display: none; }
        .filter-item, .frame-item {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.2);
            text-align: center;
            transition: all 0.18s ease;
            border: 1px solid rgba(255,255,255,0.12);
        }
        .filter-item:hover, .frame-item:hover { transform: translateY(-4px) scale(1.01); box-shadow: 0 20px 44px rgba(0,0,0,0.24); }
        .filter-img, .frame-preview { width: 100%; height: auto; max-height: 300px; object-fit: contain; border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        .frame-preview { max-height: 340px; }
        #stripPreview { max-height: 800px; }
        #formSection { background: rgba(255,255,255,0.08); padding: 18px; border-radius: 16px; margin: 20px 0; display: none; border: 1px solid rgba(255,255,255,0.12); }
        input[type="text"], input[type="email"] { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; background: transparent; color: #eaeaf2; }
        input:focus { outline: none; border-color: #f5576c; }
        #status { margin: 15px 0; font-weight: 600; padding: 10px; border-radius: 10px; }
        .success { background: rgba(22,163,74,0.15); color: #12b35b; }
        .error { background: rgba(220,38,38,0.15); color: #ef4444; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f5576c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .reveal { opacity: 0; transform: translateY(14px); transition: opacity .4s ease, transform .4s ease; }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        .qr-fixed { position: fixed; bottom: 20px; right: 20px; width: 95px; border-radius: 12px; opacity: 0.92; z-index: 9999; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
        .qr-fixed:hover { transform: scale(1.07); opacity: 1; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .filters-grid, .frames-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
            .filter-img { max-height: 220px; }
            .frame-preview { max-height: 260px; }
            #stripPreview { max-height: 600px; }
        }
    </style>
</head>
<body>
    <img src="./qr.png" class="qr-fixed" alt="QR Code">

    <div class="container">
        <div class="brand">
            <img src="lg.jpg" alt="Logo" class="logo">
            <h1>Photobooth G√¢y Qu·ªπ | DAI NAM UNI</h1>
        </div>
        <h6 style="text-align:right">Version 2.0</h6>
        <p class="intro">Upload ·∫£nh, t·∫°o ngay ·∫£nh photobooth ƒë·∫πp lung linh <3 ƒë·ª´ng qu√™n ·ªßng h·ªô ch√∫ng m√¨nh ·ªü g√≥c ph·∫£i m√†n h√¨nh‚ú®</p>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>Ch·ªçn ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            <small>H·ªó tr·ª£ JPG/PNG/CR2 < 10MB</small>
        </div>
        <input type="file" id="fileInput" accept="image/jpeg,image/png,image/cr2" onchange="loadImage(event)">

        <img id="preview" class="preview" style="display: none;">

        <button id="generateBtn" onclick="generateFilters()" disabled>T·∫°o ngay ...</button>
        <button id="resetBtn" onclick="resetApp()" style="display: none;">üîÑ Reset</button>

        <div id="progress" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>ƒêang t·∫°o 4 filter... Vui l√≤ng ch·ªù!</p>
        </div>

        <div id="setInfo" style="display: none;">B·ªô hi·ªán t·∫°i: <span id="currentSet">1</span>/13 (50 filter t·ªïng)</div>
        <button id="nextSetBtn" onclick="nextFilterSet()" style="display: none;">‚û°Ô∏è B·ªô Ti·∫øp Theo</button>

        <div id="filtersGrid" class="filters-grid"></div>
        <button id="generateStripBtn" onclick="generatePhotoboothStrip()" style="display: none; width: 100%; margin-bottom: 20px;">üé† Ch·ªçn M·∫´u Photobooth d∆∞·ªõi ƒë√¢y!</button>
        <img id="stripPreview" class="preview" style="display: none;" alt="Photobooth Strip Preview">
        <div id="framesGrid" class="frames-grid"></div>

        <div id="formSection">
            <h3 style="text-align: center; margin-bottom: 20px;">Chia s·∫ª k·ª∑ ni·ªám</h3>
            <div class="form-group"><input type="text" id="donorName" placeholder="T√™n ng∆∞·ªùi ·ªßng h·ªô" required></div>
            <div class="form-group"><input type="email" id="donorEmail" placeholder="Email nh·∫≠n ·∫£nh" required></div>
            <button onclick="downloadAll()">üì¶ T·∫£i To√†n B·ªô ·∫¢nh</button>
            <button onclick="downloadStrip()">üì∏ T·∫£i Photobooth</button>
            <button onclick="sendSelected()">üìß G·ª≠i Th√¥ng B√°o</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        let originalImage = null;
        let originalDataURL = null;
        let filterImages = {};
        let selectedFilter = null;
        let selectedFrame = null;
        let stripDataURL = null;
        let currentSet = 0;
        let allFilters = [];  // S·∫Ω ƒë∆∞·ª£c s·∫Øp x·∫øp xen k·∫Ω

        const status = document.getElementById('status');
        const filtersGrid = document.getElementById('filtersGrid');
        const framesGrid = document.getElementById('framesGrid');
        const progress = document.getElementById('progress');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const nextSetBtn = document.getElementById('nextSetBtn');
        const generateStripBtn = document.getElementById('generateStripBtn');
        const stripPreview = document.getElementById('stripPreview');
        const setInfo = document.getElementById('setInfo');
        const currentSetSpan = document.getElementById('currentSet');

        emailjs.init('WMR-hVI4x19gyn3uT');

        function initFilters() {
            // Danh s√°ch g·ªëc
            const cinematic = [
               { name: 'Clean Natural', filter: 'contrast(108%) brightness(105%) saturate(110%)' },
                { name: 'Cine Deep Indigo', filter: 'contrast(120%) brightness(95%) saturate(115%) hue-rotate(210deg)' },
                { name: 'Cine Dark Fade', filter: 'contrast(140%) brightness(88%) saturate(90%) sepia(10%)' },
                { name: 'Cine Olive Shadows', filter: 'contrast(115%) brightness(94%) hue-rotate(150deg) saturate(130%)' },
                { name: 'Cine Silver Blue', filter: 'contrast(122%) brightness(101%) saturate(118%) hue-rotate(190deg)' },
                { name: 'Cine Gold Warm', filter: 'contrast(112%) saturate(120%) brightness(107%) sepia(20%)' },
                { name: 'Cine Urban Matte', filter: 'contrast(104%) brightness(93%) saturate(80%) grayscale(15%)' },
                { name: 'Cine Vintage Bronze', filter: 'contrast(115%) brightness(96%) sepia(35%) saturate(120%)' },
                { name: 'Cine Cold Night', filter: 'contrast(135%) brightness(90%) hue-rotate(240deg)' },
                { name: 'Cine Highlight Glow', filter: 'contrast(112%) brightness(115%) saturate(130%)' }
            ];
            const pastel = [
                { name: 'Clean Sharp Daylight', filter: 'contrast(118%) brightness(106%) saturate(115%)' },
                { name: 'Pastel Aqua Wash', filter: 'brightness(120%) saturate(118%) hue-rotate(185deg)' },
                { name: 'Pastel Cloud Pink', filter: 'brightness(117%) saturate(130%) hue-rotate(350deg)' },
                { name: 'Pastel Cream Rose', filter: 'brightness(112%) saturate(110%) sepia(8%) hue-rotate(5deg)' },
                { name: 'Pastel Lemon Fade', filter: 'brightness(125%) saturate(140%) hue-rotate(70deg)' },
                { name: 'Pastel Mint Breeze', filter: 'brightness(118%) saturate(122%) hue-rotate(155deg)' },
                { name: 'Pastel Sky Glow', filter: 'brightness(120%) saturate(115%) hue-rotate(200deg)' },
                { name: 'Pastel Soft Violet', filter: 'brightness(115%) saturate(110%) hue-rotate(260deg)' },
                { name: 'Pastel Smooth Blue', filter: 'brightness(123%) saturate(112%) hue-rotate(210deg)' },
                { name: 'Pastel Candy Glow', filter: 'brightness(118%) saturate(140%) hue-rotate(350deg)' }
            ];
            const golden = [
                { name: 'Clean Neutral', filter: 'contrast(105%) brightness(102%) saturate(105%)' },
                { name: 'Golden Hour Ultra', filter: 'sepia(45%) saturate(135%) brightness(113%) hue-rotate(12deg)' },
                { name: 'Amber Honey', filter: 'sepia(30%) saturate(130%) brightness(110%) hue-rotate(30deg)' },
                { name: 'Champagne Glow', filter: 'sepia(18%) saturate(115%) brightness(109%)' },
                { name: 'Royal Gold Max', filter: 'sepia(55%) saturate(145%) brightness(102%)' },
                { name: 'Warm Cream Soft', filter: 'sepia(15%) brightness(116%) saturate(110%)' },
                { name: 'Golden Film Pro', filter: 'sepia(40%) contrast(112%) brightness(103%)' },
                { name: 'Soft Sunset Gold', filter: 'saturate(115%) brightness(110%) hue-rotate(22deg)' },
                { name: 'Amber Vintage', filter: 'sepia(35%) saturate(130%) brightness(96%) contrast(112%)' },
                { name: 'Ivory Gold', filter: 'sepia(25%) saturate(105%) brightness(115%)' }
            ];
            const moody = [
                { name: 'Film Fuji Soft', filter: 'brightness(110%) saturate(105%) contrast(103%)' },
                { name: 'Moody Dark Forest', filter: 'contrast(130%) brightness(88%) hue-rotate(150deg) saturate(75%)' },
                { name: 'Moody Ink Navy', filter: 'contrast(122%) brightness(90%) hue-rotate(220deg)' },
                { name: 'Moody Soft Shadow', filter: 'brightness(92%) contrast(110%) grayscale(20%)' },
                { name: 'Moody Warm Fade', filter: 'contrast(115%) brightness(95%) sepia(20%) saturate(90%)' },
                { name: 'Moody Fog Gray', filter: 'brightness(105%) saturate(80%) grayscale(15%)' },
                { name: 'Moody Deep Violet', filter: 'contrast(130%) brightness(88%) hue-rotate(280deg)' },
                { name: 'Moody Charcoal', filter: 'contrast(140%) brightness(83%) saturate(70%) grayscale(18%)' },
                { name: 'Moody Bronze', filter: 'contrast(122%) brightness(94%) sepia(30%)' },
                { name: 'Moody Night Fade', filter: 'contrast(120%) brightness(90%) hue-rotate(250deg)' }
            ];
            const vibrant = [
                { name: 'Clean Clarity', filter: 'contrast(115%) brightness(104%) saturate(112%)' },
                { name: 'Clean Soft White', filter: 'brightness(112%) contrast(102%)' },
                { name: 'Cine Teal Orange Pro', filter: 'contrast(128%) brightness(103%) saturate(135%) hue-rotate(18deg)' },
                { name: 'Film Tokina', filter: 'contrast(113%) brightness(104%) saturate(120%)' },
                { name: 'Vivid Magenta', filter: 'saturate(175%) contrast(122%) brightness(102%) hue-rotate(295deg)' },
                { name: 'Vivid Cyber Lime', filter: 'saturate(180%) contrast(120%) brightness(108%) hue-rotate(90deg)' },
                { name: 'Vivid Purple Pop', filter: 'saturate(165%) contrast(118%) brightness(104%) hue-rotate(260deg)' },
                { name: 'Vivid Sunrise', filter: 'saturate(150%) contrast(117%) brightness(110%) hue-rotate(25deg)' },
                { name: 'Vivid Tropical', filter: 'saturate(170%) contrast(118%) brightness(107%) hue-rotate(145deg)' },
                { name: 'Vivid Rainbow', filter: 'saturate(185%) contrast(125%) brightness(103%)' }
            ];

            const standardGroups = [cinematic, pastel, golden, moody];
            const vibrantGroup = vibrant;

            // S·∫Øp x·∫øp xen k·∫Ω to√†n b·ªô 50 filter
            allFilters = [];
            let vIndex = 0;
            for (let i = 0; i < 50; i++) {
                if (i % 2 === 0) {
                    // Chu·∫©n ƒë·∫πp (lu√¢n phi√™n 4 nh√≥m)
                    const groupIndex = Math.floor(i / 2) % standardGroups.length;
                    const group = standardGroups[groupIndex];
                    const itemIndex = Math.floor((i / 2) / standardGroups.length) % group.length;
                    allFilters.push(group[itemIndex]);
                } else {
                    // S·∫∑c s·ª° (vibrant)
                    allFilters.push(vibrantGroup[vIndex % vibrantGroup.length]);
                    vIndex++;
                }
            }
        }

        const allFrames = [
            { name: 'Anh em ta c·ª© th·∫ø th√¥i h·∫π h·∫π h·∫π', url: 'https://cdn.freehihi.com/6929d01fd3d8c.png' },
            { name: '‚Ä¶ kh·ªï nh·∫•t th·∫ø gi·ªõi', url: 'https://cdn.freehihi.com/6873abf8e3917.png' },
            { name: 'ƒêo√°n v·ªôi‚Ä¶', url: 'https://cdn.freehihi.com/68e8e901bae50.png' },
            { name: 'Im l·∫∑ng ƒëi gopi', url: 'https://cdn.freehihi.com/68b0244e76e35.png' },
            { name: 'Tr√≠ th√¥ng minh gi·∫£n z·ªã', url: 'https://cdn.freehihi.com/68529c7e26d92.png' },

            { name: 'Th√¢n ch∆∞a m√† gi·ª°n ki·ªÉu ƒë√≥', url: 'https://cdn.freehihi.com/68df420421b73.png' },
            { name: 'C·∫∑p l√¥ng m√†y skinship', url: 'https://cdn.freehihi.com/68529cd40bc49.png' },
            { name: 'Nghe b√†i Tr√¨nh ch∆∞a?', url: 'https://cdn.freehihi.com/692ed2cc19d03.png' },
            { name: '·ªû ngay trung t√¢m qu·∫≠n 1', url: 'https://cdn.freehihi.com/68d8f10969679.png' },
            { name: 'Anh/ch·ªã m√† v√¥ ch√πa l√† kh√¥ng bi·∫øt l·∫°y ai lu√¥n ƒë√≥', url: 'https://cdn.freehihi.com/692c32375296f.png' },

            { name: '·ªêi gi·ªùi √¥i, ·ªëi d·ªìi √¥i', url: 'https://cdn.freehihi.com/692c31d942db2.png' },
            { name: 'Thi·∫øu c√°i √°o c√† sa l√† th√†nh Ph·∫≠t', url: 'https://cdn.freehihi.com/68b0907158035.png' },
            { name: 'H∆°n c·∫£ khu t·ª± tr·ªã', url: 'https://cdn.freehihi.com/69029e105f6fb.png' },
            { name: 'Ki·∫øp n·∫°n th·ª© 82', url: 'https://cdn.freehihi.com/6857dd9fcbe9d.png' },
            { name: 'Flex', url: 'https://cdn.freehihi.com/68dd4f8543881.png' },

            { name: 'Slay', url: 'https://cdn.freehihi.com/690b83c2b46f0.png' },
            { name: 'Red flag', url: 'https://cdn.freehihi.com/690242dc53308.png' },
            { name: 'Pressing', url: 'https://cdn.freehihi.com/68d0dd9bb3a08.png' },
            { name: 'Gi·ªù tao ƒë∆∞a m√†y 4 t·ª∑, tao k√™u m√†y bi·∫øn, m√†y bi·∫øn kh√¥ng?', url: 'https://cdn.freehihi.com/690980ff180f2.png' },
            { name: 'Em d√†nh th·ªùi gian cho em ƒëi em!', url: 'https://cdn.freehihi.com/68d50f3783378.png' },

            { name: 'T·∫°i sao anh Pakistan l·∫°i g·ªçi cho Ny b·∫±ng s·ªë ƒëi·ªán tho·∫°i?', url: 'https://cdn.freehihi.com/692d8418563a1.png' },
            { name: 'ƒê√£ l√†m g√¨ ƒë√¢u? ƒê√£ ch·∫°m v√†o ƒë√¢u?', url: 'https://cdn.freehihi.com/6873886b68477.png' },
            { name: 'M√¨nh xin ph√©p ƒÉn mi·∫øng to nh√©', url: 'https://cdn.freehihi.com/6921c4677562b.png' },
            { name: 'ƒê·∫°i ƒë·∫°i ƒëi', url: 'https://cdn.freehihi.com/68529b5bf0b08.png' },
            { name: 'C≈©ng c≈©ng', url: 'https://cdn.freehihi.com/690ccb0bcd53e.png' },

            { name: 'Ch∆∞a c√≥ ƒë·ªß wow', url: 'https://cdn.freehihi.com/68dbb8968a7c0.png' },
            { name: '√ä nha', url: 'https://cdn.freehihi.com/6910b900890cc.png' },
            { name: 'ƒê·ªçc stk ƒë√¢y', url: 'https://cdn.freehihi.com/6873ac02ab5a1.png' },
            { name: 'C∆°m n∆∞·ªõc g√¨ ch∆∞a ng∆∞·ªùi ƒë·∫πp', url: 'https://cdn.freehihi.com/68707f70636a1.png' },
            { name: 'B√≥c tr√∫ng s√≠t r·ªãt', url: 'https://cdn.freehihi.com/68e4dff09e6d5.png' },

            { name: 'B√† n√≥i thi·ªát h·∫£ b√† Th∆°', url: 'https://cdn.freehihi.com/6852977303afd.png' },
            { name: 'Thuy·ªát h√¥m b√†', url: 'https://cdn.freehihi.com/68e73af797a67.png' },
            { name: '+1 m√°y‚Ä¶', url: 'https://cdn.freehihi.com/68ab39da93cd1.png' },
            { name: 'H∆∞·ªõng n·ªôi h·∫øt ph·∫ßn ƒë·ªùi c√≤n l·∫°i', url: 'https://cdn.freehihi.com/68dc652f832fc.png' },
            { name: 'Gi·ª°n v·∫≠y c√≥ n√™n kh√¥ng tr·ªùi', url: 'https://cdn.freehihi.com/6852d138ea7bf.png' },


            

        ];

        function showStatus(msg, isError = false) {
            status.textContent = msg;
            status.className = isError ? 'error' : 'success';
            status.style.display = 'block';
            setTimeout(() => { if (!isError) status.style.display = 'none'; }, isError ? 5000 : 3000);
        }

        function showProgress(show = true) {
            progress.style.display = show ? 'block' : 'none';
            generateBtn.disabled = show;
        }

        function resetApp() {
            originalImage = null;
            originalDataURL = null;
            filterImages = {};
            selectedFilter = null;
            selectedFrame = null;
            stripDataURL = null;
            currentSet = 0;
            filtersGrid.innerHTML = '';
            framesGrid.innerHTML = '';
            filtersGrid.style.display = 'none';
            framesGrid.style.display = 'none';
            setInfo.style.display = 'none';
            nextSetBtn.style.display = 'none';
            generateStripBtn.style.display = 'none';
            stripPreview.style.display = 'none';
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('preview').style.display = 'none';
            generateBtn.disabled = true;
            resetBtn.style.display = 'none';
            showStatus('ƒê√£ reset! Upload ·∫£nh m·ªõi nh√©.');
            document.getElementById('fileInput').value = '';
        }

        function loadImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) return showStatus('·∫¢nh qu√° l·ªõn! Gi·ªõi h·∫°n 10MB.', true);

            const reader = new FileReader();
            reader.onload = (e) => {
                originalDataURL = e.target.result;
                originalImage = new Image();
                originalImage.onload = () => {
                    document.getElementById('preview').src = originalDataURL;
                    document.getElementById('preview').style.display = 'block';
                    generateBtn.disabled = false;
                    showStatus('·∫¢nh g·ªëc s·∫µn s√†ng! Nh·∫•n t·∫°o 4 filter.');
                    initFilters();
                };
                originalImage.src = originalDataURL;
            };
            reader.readAsDataURL(file);
        }

        function applyFilter(ctx, canvas, filterStr) {
            canvas.width = originalImage.width;
            canvas.height = originalImage.height + 60;

            ctx.filter = filterStr;
            ctx.drawImage(originalImage, 0, 0, originalImage.width, originalImage.height);
            ctx.filter = 'none';

            const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2 - 30, canvas.width/3, canvas.width/2, canvas.height/2 - 30, canvas.width/1.2);
            gradient.addColorStop(0, 'rgba(255,255,255,0)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.15)');
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillRect(0, 0, canvas.width, canvas.height - 60);
            ctx.globalCompositeOperation = 'source-over';

            const stripHeight = 60;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
            ctx.fillRect(0, canvas.height - stripHeight, canvas.width, stripHeight);

            ctx.font = 'bold 30px "Playfair Display", serif';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.45)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            const text = 'KHOA CNTT - DNU K√çNH T·∫∂NG! C·∫¢M ∆†N B·∫†N ƒê√É ƒê·ªíNG H√ÄNH C√ôNG CH∆Ø∆†NG TR√åNH G√ÇY QU·ª∏ THI·ªÜN NGUY·ªÜN V√ôNG CAO 2025';
            ctx.fillText(text, canvas.width / 2, canvas.height - stripHeight / 2);

            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
        }

        function generateFilters() {
            generateBtn.classList.add("loading-btn");
            progress.style.display = "block";

            setTimeout(() => {
                if (!originalImage) return;
                showProgress(true);
                filtersGrid.innerHTML = '';
                filterImages = {};

                const start = currentSet * 4;
                const end = Math.min(start + 4, allFilters.length);
                const currentFilters = allFilters.slice(start, end);

                currentFilters.forEach((filter) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    applyFilter(ctx, canvas, filter.filter);
                    const dataURL = canvas.toDataURL('image/jpeg', 0.98);

                    filterImages[filter.name] = dataURL;

                    const item = document.createElement('div');
                    item.className = 'filter-item';
                    item.innerHTML = `
                        <img src="${dataURL}" class="filter-img" alt="${filter.name}" onclick="selectFilter('${filter.name}')">
                        <div class="filter-name">${filter.name}</div>
                        <button onclick="downloadFilter('${filter.name}')">üíæ T·∫£i</button>
                    `;
                    filtersGrid.appendChild(item);
                });

                filtersGrid.style.display = 'grid';
                renderFramesGrid();
                document.getElementById('formSection').style.display = 'block';
                resetBtn.style.display = 'inline-block';
                setInfo.style.display = 'block';
                currentSetSpan.textContent = currentSet + 1;
                if (end < allFilters.length) nextSetBtn.style.display = 'inline-block';
                generateStripBtn.style.display = 'block';
                showProgress(false);
                showStatus(`T·∫°o xong b·ªô ${currentSet + 1} (4 filter xen k·∫Ω chu·∫©n ƒë·∫πp & s·∫∑c s·ª°)!`);
                document.querySelectorAll('.filter-item').forEach(el => el.classList.add('reveal'));
                setupReveal();

                generateBtn.classList.remove("loading-btn");
            }, 200);
        }

        function renderFramesGrid() {
            framesGrid.innerHTML = '';
            allFrames.forEach((frame) => {
                const item = document.createElement('div');
                item.className = 'frame-item reveal';
                item.innerHTML = `
                    <img src="${frame.url}" class="frame-preview" alt="${frame.name}" onclick="selectFrame('${frame.name}')">
                    <div class="frame-name">${frame.name}</div>
                    <button onclick="generatePhotoboothStrip('${frame.name}')">üé® √Åp D·ª•ng</button>
                `;
                framesGrid.appendChild(item);
            });
            framesGrid.style.display = 'grid';
            setupReveal();
        }

        function selectFrame(frameName) {
            selectedFrame = frameName;
            document.querySelectorAll('.frame-item').forEach(item => item.style.border = 'none');
            event.target.parentElement.style.border = '3px solid #f5576c';
            showStatus(`ƒê√£ ch·ªçn khung: ${frameName}`);
        }

        function generatePhotoboothStrip(specificFrameName = null) {
            if (Object.keys(filterImages).length < 4) {
                return showStatus('C·∫ßn √≠t nh·∫•t 4 filter ƒë·ªÉ t·∫°o strip!', true);
            }

            const frameName = specificFrameName || selectedFrame;
            if (!frameName) return showStatus('Vui l√≤ng ch·ªçn khung photobooth!', true);

            const selectedFrameObj = allFrames.find(f => f.name === frameName);
            if (!selectedFrameObj) return showStatus('Kh√¥ng t√¨m th·∫•y khung!', true);

            showProgress(true);

            const frameImg = new Image();
            frameImg.crossOrigin = 'anonymous';
            frameImg.src = selectedFrameObj.url;

            frameImg.onload = () => {
                const filterKeys = Object.keys(filterImages).slice(0, 4);
                const imagesToUse = filterKeys.map(key => filterImages[key]);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = frameImg.width;
                canvas.height = frameImg.height;

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const gap = 38;
                const totalHeight = canvas.height;
                const availableHeight = totalHeight - gap * 3;
                const slotHeight = availableHeight / 4;

                let loadedCount = 0;
                imagesToUse.forEach((imgSrc, index) => {
                    const photoImg = new Image();
                    photoImg.crossOrigin = 'anonymous';
                    photoImg.onload = () => {
                        const slotY = index * (slotHeight + gap);
                        const margin = 30;
                        const slotWidth = canvas.width - margin * 2;

                        const scaleX = slotWidth / photoImg.width;
                        const scaleY = slotHeight / photoImg.height;
                        const scale = Math.max(scaleX, scaleY);

                        const drawWidth = photoImg.width * scale;
                        const drawHeight = photoImg.height * scale;
                        const drawX = (canvas.width - drawWidth) / 2;
                        const drawY = slotY + (slotHeight - drawHeight) / 2;

                        ctx.drawImage(photoImg, drawX, drawY, drawWidth, drawHeight);

                        loadedCount++;
                        if (loadedCount === 4) {
                            ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);

                            ctx.filter = 'contrast(110%) brightness(105%)';
                            ctx.drawImage(canvas, 0, 0);
                            ctx.filter = 'none';

                            stripDataURL = canvas.toDataURL('image/png', 1.0);
                            stripPreview.src = stripDataURL;
                            stripPreview.style.display = 'block';
                            showProgress(false);
                            showStatus(`T·∫°o strip "${frameName}" th√†nh c√¥ng!`);
                        }
                    };
                    photoImg.src = imgSrc;
                });
            };
            frameImg.onerror = () => {
                showProgress(false);
                showStatus('L·ªói load khung template!', true);
            };
        }

        function nextFilterSet() {
            if (currentSet < 12) {  // 13 b·ªô (0-12)
                currentSet++;
                generateFilters();
            } else {
                showStatus('ƒê√£ h·∫øt t·∫•t c·∫£ 50 filter!', true);
            }
        }

        function selectFilter(filterName) {
            selectedFilter = filterName;
            document.querySelectorAll('.filter-item').forEach(item => item.style.border = 'none');
            event.target.parentElement.style.border = '3px solid #f5576c';
            showStatus(`ƒê√£ ch·ªçn: ${filterName}`);
        }

        function downloadFilter(filterName) {
            const dataURL = filterImages[filterName];
            const link = document.createElement('a');
            link.download = `anh-${filterName.replace(/[^a-zA-Z0-9]/g, '-')}.jpg`;
            link.href = dataURL;
            link.click();
            showStatus(`ƒê√£ t·∫£i ${filterName}!`);
        }

        function downloadStrip() {
            if (!stripDataURL) return showStatus('Ch∆∞a t·∫°o strip!', true);
            const link = document.createElement('a');
            link.download = `photobooth-strip-${selectedFrame || 'default'}.png`;
            link.href = stripDataURL;
            link.click();
            showStatus(`ƒê√£ t·∫£i Strip Photobooth!`);
        }

        async function downloadAll() {
            if (Object.keys(filterImages).length === 0) return showStatus('Ch∆∞a c√≥ ·∫£nh!', true);
            const zip = new JSZip();
            Object.keys(filterImages).forEach(name => {
                const base64 = filterImages[name].split(',')[1];
                zip.file(`${name.replace(/[^a-zA-Z0-9]/g, '-')}.jpg`, base64, { base64: true });
            });
            if (stripDataURL) {
                const stripBase64 = stripDataURL.split(',')[1];
                zip.file(`photobooth-strip-${selectedFrame || 'default'}.png`, stripBase64, { base64: true });
            }
            const content = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.download = `bo-${currentSet + 1}-4-anh-gay-quy-strip.zip`;
            link.href = URL.createObjectURL(content);
            link.click();
            showStatus('ƒê√£ t·∫£i ZIP b·ªô hi·ªán t·∫°i + Strip!');
        }

        async function sendSelected() {
            const name = document.getElementById('donorName').value.trim();
            const email = document.getElementById('donorEmail').value.trim();
            if (!name || !email) return showStatus('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!', true);

            showProgress(true);
            const message = `C·∫£m ∆°n ${name} ƒë√£ ·ªßng h·ªô! ${selectedFilter ? `Filter: "${selectedFilter}"` : ''} ${selectedFrame ? `Khung: "${selectedFrame}"` : ''}. Vui l√≤ng IB Zalo 0345335303 ƒë·ªÉ nh·∫≠n ·∫£nh. Studio G√¢y Qu·ªπ - DAI NAM UNI.`;
            try {
                await emailjs.send('service_h9b0zrm', 'template_ecf93dw', {
                    to_email: email,
                    donor_name: name,
                    message: message
                });
                showStatus(`G·ª≠i th√¥ng b√°o th√†nh c√¥ng cho ${name}!`);
                document.getElementById('donorName').value = '';
                document.getElementById('donorEmail').value = '';
            } catch (error) {
                showStatus('L·ªói g·ª≠i email: ' + error.text, true);
            } finally {
                showProgress(false);
            }
        }

        function setupReveal() {
            const observer = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    if (e.isIntersecting) e.target.classList.add('visible');
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('fileInput');
            uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragging'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragging'));
            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                if (e.dataTransfer.files[0]) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
            setupReveal();
        });
    </script>
</body>
</html>
