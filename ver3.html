<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./lg.jpg" type="image/png">
    <title>Studio G√¢y Qu·ªπ ‚Äî FauTaubooth</title>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=DM+Serif+Display:ital@0;1&family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: linear-gradient(180deg, rgba(15,15,18,0.25), rgba(15,15,18,0.25)),
                        url('./lg.jpg') left center / 50% 100% no-repeat,
                        url('./lg.jpg') right center / 50% 100% no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: #eaeaf2;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }
        .snow { position: fixed; top: -10px; left: 0; width: 8px; height: 8px; background: #fff; border-radius: 50%; pointer-events: none; z-index: 1000; animation: snowfall linear infinite; }
        @keyframes snowfall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        h1 { font-family: 'Andale Mono', monospace; font-weight: 700; font-size: clamp(2em, 5.5vw, 3.6em); color: #fff; letter-spacing: 0.6px; margin-bottom: 12px; text-shadow: 0 2px 8px rgba(0,0,0,0.35); }
        .brand { display: flex; align-items: center; gap: 14px; }
        .logo { width: 56px; height: 56px; object-fit: cover; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 12px 28px rgba(0,0,0,0.35); }
        @media (max-width: 768px) { .logo { width: 44px; height: 44px; } }
        p.intro { font-size: 1.05em; color: #fff; margin-bottom: 28px; opacity: 0.92; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.12);
            position: relative;
            z-index: 10;
        }
        .upload-area, .camera-area {
            border: 2px dashed rgba(255,255,255,0.25);
            border-radius: 16px;
            padding: 32px;
            margin: 30px 0;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        .upload-area:hover, .camera-area:hover { border-color: #f5576c; transform: scale(1.01); }
        .upload-area.dragging, .camera-area.dragging { border-color: #8a8aff; transform: scale(1.02); }
        .upload-area::before, .camera-area::before { content: 'üì∏'; font-size: 2.4em; display: block; margin-bottom: 10px; }
        input[type="file"] { display: none; }
        #video { width: 100%; max-width: 480px; height: auto; border-radius: 12px; display: none; }
        #countdownOverlay {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4em; font-weight: bold; color: #f5576c; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 50%; display: none;
        }
        .previews-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; display: none; }
        .preview-item { text-align: center; background: rgba(255,255,255,0.08); border-radius: 16px; padding: 10px; border: 1px solid rgba(255,255,255,0.12); }
        .preview-img { max-width: 100%; max-height: 300px; border-radius: 12px; object-fit: contain; margin-bottom: 8px; }
        .preview { max-width: 100%; max-height: 800px; border-radius: 16px; margin: 18px auto; display: none; box-shadow: 0 18px 40px rgba(0,0,0,0.25); object-fit: contain; }
        button {
            background: linear-gradient(135deg, #f5576c, #6c7cff);
            color: #fff;
            border: 0;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 5px;
            transition: all 0.18s ease;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,0.22); }
        button:disabled { background: #656b7a; cursor: not-allowed; }
        #downloadAllFramesBtn { background: linear-gradient(135deg, #ff6b6b, #ff8e53) !important; }
        #uploadStatus { font-weight: bold; color: #f5576c; margin: 10px 0; }
        .frames-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 30px 0; display: none; }
        .frame-item { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 14px; box-shadow: 0 18px 40px rgba(0,0,0,0.2); text-align: center; transition: all 0.18s ease; border: 1px solid rgba(255,255,255,0.12); }
        .frame-item:hover { transform: translateY(-4px) scale(1.01); box-shadow: 0 20px 44px rgba(0,0,0,0.24); }
        .frame-preview { width: 100%; height: auto; max-height: 340px; object-fit: contain; border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        #status { margin: 15px 0; font-weight: 600; padding: 10px; border-radius: 10px; }
        .success { background: rgba(22,163,74,0.15); color: #12b35b; }
        .error { background: rgba(220,38,38,0.15); color: #ef4444; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f5576c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reveal { opacity: 0; transform: translateY(14px); transition: opacity .4s ease, transform .4s ease; }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        .qr-fixed { position: fixed; bottom: 20px; right: 20px; width: 95px; border-radius: 12px; opacity: 0.92; z-index: 9999; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
        .qr-fixed:hover { transform: scale(1.07); opacity: 1; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .frames-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
            .frame-preview { max-height: 260px; }
            .previews-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            #video { max-width: 100%; }
        }
        #adjustControls { margin: 10px 0; display: none; }
        #stripPreview.draggable { cursor: move; }
    </style>
</head>
<body>
    <img src="./qr.png" class="qr-fixed" alt="QR Code">

    <div class="container">
        <div class="brand">
            <img src="lg.jpg" alt="Logo" class="logo">
            <h1>Photobooth G√¢y Qu·ªπ | DAI NAM UNI</h1>
        </div>
        <h6 style="text-align:right">Version 3.0</h6>
        <p class="intro">Ch·ª•p tr·ª±c ti·∫øp qua camera ho·∫∑c upload 4 ·∫£nh ƒë·ªÉ t·∫°o photobooth ƒë·∫πp lung linh <3 ƒë·ª´ng qu√™n ·ªßng h·ªô ch√∫ng m√¨nh ·ªü g√≥c ph·∫£i m√†n h√¨nh‚ú®</p>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>üìÅ Upload 4 ·∫£nh</p>
            <small>(Ch·ª•p theo th·ª© t·ª± 1-2-3-4)</small>
        </div>
        <input type="file" id="fileInput" accept="image/jpeg,image/png,image/cr2" multiple onchange="loadImages(event)" max="4">

        <button id="startCameraBtn" onclick="startCameraSession()" style="width: 100%; margin: 20px 0;">üé• B·∫Øt ƒê·∫ßu Ch·ª•p Photobooth Qua Camera</button>

        <div class="camera-area" id="cameraArea" style="display: none;">
            <video id="video" autoplay playsinline></video>
            <div id="countdownOverlay"></div>
        </div>

        <div id="uploadStatus" style="display: none;">ƒê√£ upload <span id="uploadedCount">0</span>/4 ·∫£nh</div>

        <div id="previewsGrid" class="previews-grid"></div>

        <button id="generateStripBtn" onclick="generatePhotoboothStrip()" disabled style="width: 100%; margin: 20px 0;">üé† Ch·ªçn M·∫´u Photobooth v√† T·∫°o Strip!</button>

        <button id="downloadAllFramesBtn" onclick="downloadAllFrames()" disabled style="width: 100%; margin: 20px 0;">
            üì¶ T·∫£i T·∫•t C·∫£ 4 ·∫¢nh + To√†n B·ªô Khung Photobooth
        </button>

        <div id="adjustControls" style="display: none;">
            <p>Di chuy·ªÉn k√©o ·∫£nh ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠, r·ªìi nh·∫•n OK ƒë·ªÉ c·ªë ƒë·ªãnh.</p>
            <button id="fixPositionBtn" onclick="fixPosition()">OK - C·ªë ƒê·ªãnh V·ªã Tr√≠</button>
        </div>

        <img id="stripPreview" class="preview" style="display: none;" alt="Photobooth Strip Preview">
        <div id="framesGrid" class="frames-grid"></div>

        <div id="status"></div>
    </div>

    <script>
        // Hi·ªáu ·ª©ng tuy·∫øt r∆°i
        function createSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.className = 'snow';
            snowflake.style.left = Math.random() * 100 + 'vw';
            snowflake.style.opacity = Math.random();
            snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
            snowflake.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(snowflake);
            setTimeout(() => snowflake.remove(), 10000);
        }
        setInterval(createSnowflake, 200);

        let userImages = [];
        let selectedFrame = null;
        let stripDataURL = null;
        let mediaStream = null;
        let captureCanvas = null;
        const INITIAL_COUNTDOWN = 5000;
        const SHOT_COUNTDOWN = 3000;
        let offsetX = 0; // V·ªã tr√≠ ƒëi·ªÅu ch·ªânh ngang
        let offsetY = 0; // V·ªã tr√≠ ƒëi·ªÅu ch·ªânh d·ªçc
        let isDragging = false;
        let startX, startY;
        let currentFrameObj = null; // ƒê·ªÉ l∆∞u khung hi·ªán t·∫°i khi ƒëi·ªÅu ch·ªânh
        let isFixed = false; // C·ªë ƒë·ªãnh v·ªã tr√≠ ch∆∞a

        const status = document.getElementById('status');
        const previewsGrid = document.getElementById('previewsGrid');
        const framesGrid = document.getElementById('framesGrid');
        const generateStripBtn = document.getElementById('generateStripBtn');
        const downloadAllFramesBtn = document.getElementById('downloadAllFramesBtn');
        const stripPreview = document.getElementById('stripPreview');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadedCount = document.getElementById('uploadedCount');
        const video = document.getElementById('video');
        const cameraArea = document.getElementById('cameraArea');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const adjustControls = document.getElementById('adjustControls');
        const fixPositionBtn = document.getElementById('fixPositionBtn');

        emailjs.init('WMR-hVI4x19gyn3uT');

        const allFrames = [
            { name: 'Anh em ta c·ª© th·∫ø th√¥i h·∫π h·∫π h·∫π', url: 'https://cdn.freehihi.com/6929d01fd3d8c.png', paddingTop: 90, paddingBottom: 60, gap: 40 },
            { name: '‚Ä¶ kh·ªï nh·∫•t th·∫ø gi·ªõi', url: 'https://cdn.freehihi.com/6873abf8e3917.png', paddingTop: 100, paddingBottom: 70, gap: 30 },
            { name: 'ƒêo√°n v·ªôi‚Ä¶', url: 'https://cdn.freehihi.com/68e8e901bae50.png', paddingTop: 80, paddingBottom: 50, gap: 35 },
            { name: 'Im l·∫∑ng ƒëi gopi', url: 'https://cdn.freehihi.com/68b0244e76e35.png', paddingTop: 90, paddingBottom: 60, gap: 40 },
            { name: 'Tr√≠ th√¥ng minh gi·∫£n z·ªã', url: 'https://cdn.freehihi.com/68529c7e26d92.png', paddingTop: 85, paddingBottom: 55, gap: 35 },
            { name: 'Th√¢n ch∆∞a m√† gi·ª°n ki·ªÉu ƒë√≥', url: 'https://cdn.freehihi.com/68df420421b73.png', paddingTop: 90, paddingBottom: 60, gap: 30 },
            { name: 'C·∫∑p l√¥ng m√†y skinship', url: 'https://cdn.freehihi.com/68529cd40bc49.png', paddingTop: 95, paddingBottom: 65, gap: 35 },
            { name: 'Nghe b√†i Tr√¨nh ch∆∞a?', url: 'https://cdn.freehihi.com/692ed2cc19d03.png', paddingTop: 100, paddingBottom: 70, gap: 40 },
            { name: '·ªû ngay trung t√¢m qu·∫≠n 1', url: 'https://cdn.freehihi.com/68d8f10969679.png', paddingTop: 90, paddingBottom: 60, gap: 35 },
            { name: 'Anh/ch·ªã m√† v√¥ ch√πa l√† kh√¥ng bi·∫øt l·∫°y ai lu√¥n ƒë√≥', url: 'https://cdn.freehihi.com/692c32375296f.png', paddingTop: 105, paddingBottom: 75, gap: 30 },
            { name: '·ªêi gi·ªùi √¥i, ·ªëi d·ªìi √¥i', url: 'https://cdn.freehihi.com/692c31d942db2.png', paddingTop: 80, paddingBottom: 50, gap: 40 },
            { name: 'Thi·∫øu c√°i √°o c√† sa l√† th√†nh Ph·∫≠t', url: 'https://cdn.freehihi.com/68b0907158035.png', paddingTop: 90, paddingBottom: 60, gap: 35 },
            { name: 'H∆°n c·∫£ khu t·ª± tr·ªã', url: 'https://cdn.freehihi.com/69029e105f6fb.png', paddingTop: 95, paddingBottom: 65, gap: 40 },
            { name: 'Ki·∫øp n·∫°n th·ª© 82', url: 'https://cdn.freehihi.com/6857dd9fcbe9d.png', paddingTop: 100, paddingBottom: 70, gap: 35 },
            { name: 'Flex', url: 'https://cdn.freehihi.com/68dd4f8543881.png', paddingTop: 85, paddingBottom: 55, gap: 30 },
            { name: 'Slay', url: 'https://cdn.freehihi.com/690b83c2b46f0.png', paddingTop: 90, paddingBottom: 60, gap: 35 },
            { name: 'Red flag', url: 'https://cdn.freehihi.com/690242dc53308.png', paddingTop: 95, paddingBottom: 65, gap: 40 },
            { name: 'Pressing', url: 'https://cdn.freehihi.com/68d0dd9bb3a08.png', paddingTop: 100, paddingBottom: 70, gap: 35 },
            { name: 'Gi·ªù tao ƒë∆∞a m√†y 4 t·ª∑, tao k√™u m√†y bi·∫øn, m√†y bi·∫øn kh√¥ng?', url: 'https://cdn.freehihi.com/690980ff180f2.png', paddingTop: 90, paddingBottom: 60, gap: 40 },
            { name: 'Em d√†nh th·ªùi gian cho em ƒëi em!', url: 'https://cdn.freehihi.com/68d50f3783378.png', paddingTop: 85, paddingBottom: 55, gap: 35 },
            { name: 'T·∫°i sao anh Pakistan l·∫°i g·ªçi cho Ny b·∫±ng s·ªë ƒëi·ªán tho·∫°i?', url: 'https://cdn.freehihi.com/692d8418563a1.png', paddingTop: 95, paddingBottom: 65, gap: 30 },
            { name: 'ƒê√£ l√†m g√¨ ƒë√¢u? ƒê√£ ch·∫°m v√†o ƒë√¢u?', url: 'https://cdn.freehihi.com/6873886b68477.png', paddingTop: 90, paddingBottom: 60, gap: 35 },
            { name: 'M√¨nh xin ph√©p ƒÉn mi·∫øng to nh√©', url: 'https://cdn.freehihi.com/6921c4677562b.png', paddingTop: 100, paddingBottom: 70, gap: 40 },
            { name: 'ƒê·∫°i ƒë·∫°i ƒëi', url: 'https://cdn.freehihi.com/68529b5bf0b08.png', paddingTop: 85, paddingBottom: 55, gap: 35 },
            { name: 'C≈©ng c≈©ng', url: 'https://cdn.freehihi.com/690ccb0bcd53e.png', paddingTop: 90, paddingBottom: 60, gap: 30 },
            { name: 'Ch∆∞a c√≥ ƒë·ªß wow', url: 'https://cdn.freehihi.com/68dbb8968a7c0.png', paddingTop: 95, paddingBottom: 65, gap: 35 },
            { name: '√ä nha', url: 'https://cdn.freehihi.com/6910b900890cc.png', paddingTop: 90, paddingBottom: 60, gap: 40 },
            { name: 'ƒê·ªçc stk ƒë√¢y', url: 'https://cdn.freehihi.com/6873ac02ab5a1.png', paddingTop: 100, paddingBottom: 70, gap: 35 },
            { name: 'C∆°m n∆∞·ªõc g√¨ ch∆∞a ng∆∞·ªùi ƒë·∫πp', url: 'https://cdn.freehihi.com/68707f70636a1.png', paddingTop: 85, paddingBottom: 55, gap: 30 },
            { name: 'B√≥c tr√∫ng s√≠t r·ªãt', url: 'https://cdn.freehihi.com/68e4dff09e6d5.png', paddingTop: 90, paddingBottom: 60, gap: 35 },
            { name: 'B√† n√≥i thi·ªát h·∫£ b√† Th∆°', url: 'https://cdn.freehihi.com/6852977303afd.png', paddingTop: 95, paddingBottom: 65, gap: 40 },
            { name: 'Thuy·ªát h√¥m b√†', url: 'https://cdn.freehihi.com/68e73af797a67.png', paddingTop: 90, paddingBottom: 60, gap: 35 },
            { name: '+1 m√°y‚Ä¶', url: 'https://cdn.freehihi.com/68ab39da93cd1.png', paddingTop: 100, paddingBottom: 70, gap: 30 },
            { name: 'H∆∞·ªõng n·ªôi h·∫øt ph·∫ßn ƒë·ªùi c√≤n l·∫°i', url: 'https://cdn.freehihi.com/68dc652f832fc.png', paddingTop: 85, paddingBottom: 55, gap: 35 },
            { name: 'Gi·ª°n v·∫≠y c√≥ n√™n kh√¥ng tr·ªùi', url: 'https://cdn.freehihi.com/6852d138ea7bf.png', paddingTop: 90, paddingBottom: 60, gap: 40 },
        ];

        function showStatus(msg, isError = false) {
            status.textContent = msg;
            status.className = isError ? 'error' : 'success';
            status.style.display = 'block';
            setTimeout(() => { if (!isError) status.style.display = 'none'; }, isError ? 5000 : 3000);
        }

        function showProgress(show = true, msg = 'ƒêang x·ª≠ l√Ω...') {
            const progress = document.getElementById('progress') || createProgressElement();
            progress.innerHTML = `<div class="spinner"></div><p>${msg}</p>`;
            progress.style.display = show ? 'block' : 'none';
            generateStripBtn.disabled = show;
            downloadAllFramesBtn.disabled = show;
        }

        function createProgressElement() {
            const progress = document.createElement('div');
            progress.id = 'progress';
            progress.style.cssText = 'text-align: center; margin: 20px 0; display: none;';
            document.querySelector('.container').appendChild(progress);
            return progress;
        }

        async function startCameraSession() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } });
                video.srcObject = mediaStream;
                video.style.display = 'block';
                cameraArea.style.display = 'block';
                startCameraBtn.style.display = 'none';
                showStatus('Camera s·∫µn s√†ng! Nh·∫•n OK ƒë·ªÉ b·∫Øt ƒë·∫ßu countdown 5s cho shot 1.');

                const startBtn = document.createElement('button');
                startBtn.textContent = 'OK - B·∫Øt ƒê·∫ßu!';
                startBtn.onclick = () => {
                    cameraArea.removeChild(startBtn);
                    startShotCountdown(INITIAL_COUNTDOWN / 1000, 1);
                };
                startBtn.style.width = '100%';
                cameraArea.appendChild(startBtn);
            } catch (err) {
                showStatus('L·ªói truy c·∫≠p camera: ' + err.message, true);
            }
        }

        function startShotCountdown(seconds, shotNumber) {
            countdownOverlay.style.display = 'block';
            let timeLeft = seconds;
            const countdown = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    countdownOverlay.textContent = `${timeLeft}s - Shot ${shotNumber}!`;
                } else {
                    clearInterval(countdown);
                    countdownOverlay.style.display = 'none';
                    takePhoto(shotNumber);
                }
            }, 1000);
        }

        function takePhoto(shotNumber) {
            if (!captureCanvas) captureCanvas = document.createElement('canvas');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            const ctx = captureCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const dataURL = captureCanvas.toDataURL('image/jpeg', 0.9);
            const img = new Image();
            img.src = dataURL;
            img.onload = () => {
                userImages.push({ dataURL, img, name: `shot_${shotNumber}.jpg` });
                showStatus(`ƒê√£ ch·ª•p shot ${shotNumber}/4 th√†nh c√¥ng!`);

                if (shotNumber < 4) {
                    setTimeout(() => {
                        showStatus(`Chu·∫©n b·ªã Shot ${shotNumber + 1}...`);
                        startShotCountdown(SHOT_COUNTDOWN / 1000, shotNumber + 1);
                    }, 1000);
                } else {
                    setTimeout(() => {
                        stopCamera();
                        showPreviews();
                    }, 1000);
                }
            };
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            video.style.display = 'none';
            cameraArea.style.display = 'none';
            startCameraBtn.style.display = 'block';
        }

        function showPreviews() {
            previewsGrid.innerHTML = '';
            userImages.forEach((userImg, idx) => {
                const item = document.createElement('div');
                item.className = 'preview-item reveal';
                item.innerHTML = `
                    <img src="${userImg.dataURL}" class="preview-img" alt="·∫¢nh ${idx + 1}">
                    <div>·∫¢nh ${idx + 1}: ${userImg.name}</div>
                `;
                previewsGrid.appendChild(item);
            });
            uploadedCount.textContent = userImages.length;
            uploadStatus.style.display = 'block';
            previewsGrid.style.display = 'grid';
            generateStripBtn.disabled = false;
            downloadAllFramesBtn.disabled = false;
            renderFramesGrid();
            showStatus(`ƒê√£ ch·ª•p ƒë·ªß 4 ·∫£nh! Ch·ªçn khung ho·∫∑c t·∫£i t·∫•t c·∫£ ngay!`);
            setupReveal();
        }

        function loadImages(event) {
            const files = Array.from(event.target.files).slice(0, 4);
            if (files.length === 0) return;

            userImages = [];
            previewsGrid.innerHTML = '';
            let loadedCount = 0;

            files.forEach((file, index) => {
                if (file.size > 10 * 1024 * 1024) {
                    showStatus(`·∫¢nh ${index + 1} qu√° l·ªõn! B·ªè qua.`, true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        userImages.push({ dataURL: e.target.result, img, name: file.name });
                        loadedCount++;

                        const item = document.createElement('div');
                        item.className = 'preview-item reveal';
                        item.innerHTML = `
                            <img src="${e.target.result}" class="preview-img" alt="·∫¢nh ${index + 1}">
                            <div>·∫¢nh ${index + 1}: ${file.name}</div>
                            <button onclick="removeImage(${userImages.length - 1})" style="background:#ef4444; font-size:0.8em; padding:6px 12px;">‚ùå X√≥a</button>
                        `;
                        previewsGrid.appendChild(item);

                        uploadedCount.textContent = loadedCount;
                        uploadStatus.style.display = 'block';
                        previewsGrid.style.display = 'grid';

                        if (loadedCount === files.length) {
                            if (loadedCount === 4) {
                                generateStripBtn.disabled = false;
                                downloadAllFramesBtn.disabled = false;
                                renderFramesGrid();
                                showStatus(`ƒê√£ upload 4 ·∫£nh! Ch·ªçn khung ho·∫∑c t·∫£i t·∫•t c·∫£.`);
                            } else {
                                showStatus(`Ch·ªâ upload ƒë∆∞·ª£c ${loadedCount} ·∫£nh. C·∫ßn ƒë·ªß 4!`, true);
                            }
                        }
                        setupReveal();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            userImages.splice(index, 1);
            previewsGrid.innerHTML = '';
            userImages.forEach((userImg, idx) => {
                const item = document.createElement('div');
                item.className = 'preview-item reveal';
                item.innerHTML = `
                    <img src="${userImg.dataURL}" class="preview-img" alt="·∫¢nh ${idx + 1}">
                    <div>·∫¢nh ${idx + 1}: ${userImg.name}</div>
                    <button onclick="removeImage(${idx})" style="background:#ef4444; font-size:0.8em; padding:6px 12px;">‚ùå X√≥a</button>
                `;
                previewsGrid.appendChild(item);
            });
            uploadedCount.textContent = userImages.length;
            if (userImages.length < 4) {
                generateStripBtn.disabled = true;
                downloadAllFramesBtn.disabled = true;
                stripPreview.style.display = 'none';
                framesGrid.style.display = 'none';
            }
            showStatus(`ƒê√£ x√≥a ·∫£nh. C√≤n ${userImages.length}/4 ·∫£nh.`);
            setupReveal();
        }

        function renderFramesGrid() {
            framesGrid.innerHTML = '';
            allFrames.forEach((frame) => {
                const item = document.createElement('div');
                item.className = 'frame-item reveal';
                item.innerHTML = `
                    <img src="${frame.url}" class="frame-preview" alt="${frame.name}" onclick="selectFrame('${frame.name}')">
                    <div class="frame-name">${frame.name}</div>
                    <button onclick="generatePhotoboothStrip('${frame.name}')" style="width:100%; margin-top:8px;">üé® T·∫°o V·ªõi Khung N√†y</button>
                `;
                framesGrid.appendChild(item);
            });
            framesGrid.style.display = 'grid';
            setupReveal();
        }

        function selectFrame(frameName) {
            selectedFrame = frameName;
            document.querySelectorAll('.frame-item').forEach(item => item.style.border = 'none');
            event.target.parentElement.style.border = '3px solid #f5576c';
            showStatus(`ƒê√£ ch·ªçn khung: ${frameName}. Nh·∫•n "T·∫°o V·ªõi Khung N√†y" ƒë·ªÉ gh√©p.`);
        }

        // H√†m t·∫°o strip v·ªõi padding ƒë√£ ƒëi·ªÅu ch·ªânh
        function createStripCanvas(frameImg, paddingTop, paddingBottom, gap, offsetX = 0, offsetY = 0) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = frameImg.width;
            canvas.height = frameImg.height;

            const slotWidth = canvas.width - 80; // padding tr√°i ph·∫£i 40px
            const totalPhotoHeight = canvas.height - paddingTop - paddingBottom;
            const slotHeight = (totalPhotoHeight - gap * 3) / 4;

            let currentY = paddingTop + offsetY;

            userImages.forEach((userImg) => {
                const photoImg = userImg.img;

                const scaleX = slotWidth / photoImg.width;
                const scaleY = slotHeight / photoImg.height;
                const scale = Math.min(scaleX, scaleY);

                const drawWidth = photoImg.width * scale;
                const drawHeight = photoImg.height * scale;

                const drawX = 40 + offsetX + (slotWidth - drawWidth) / 2;
                const drawY = currentY + (slotHeight - drawHeight) / 2;

                ctx.drawImage(photoImg, drawX, drawY, drawWidth, drawHeight);
                currentY += slotHeight + gap;
            });

            ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
            ctx.filter = 'contrast(110%) brightness(105%) saturate(108%)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';

            return canvas;
        }

        function generatePhotoboothStrip(specificFrameName = null) {
            if (userImages.length !== 4) return showStatus('C·∫ßn ƒë√∫ng 4 ·∫£nh!', true);

            const frameName = specificFrameName || selectedFrame;
            if (!frameName) return showStatus('Vui l√≤ng ch·ªçn khung!', true);

            currentFrameObj = allFrames.find(f => f.name === frameName);
            if (!currentFrameObj) return showStatus('Kh√¥ng t√¨m th·∫•y khung!', true);

            showProgress(true, 'ƒêang t·∫°o strip...');

            const frameImg = new Image();
            frameImg.crossOrigin = 'anonymous';
            frameImg.src = currentFrameObj.url;

            frameImg.onload = () => {
                const canvas = createStripCanvas(frameImg, currentFrameObj.paddingTop, currentFrameObj.paddingBottom, currentFrameObj.gap, offsetX, offsetY);
                stripDataURL = canvas.toDataURL('image/png', 1.0);
                stripPreview.src = stripDataURL;
                stripPreview.style.display = 'block';
                showProgress(false);
                showStatus(`T·∫°o strip "${frameName}" th√†nh c√¥ng! ·∫¢nh ƒë√£ th·∫≥ng h√†ng ho√†n h·∫£o.`);
                adjustControls.style.display = 'block'; // Hi·ªÉn th·ªã n√∫t OK
                setupDrag(); // K√≠ch ho·∫°t k√©o
                isFixed = false;
            };

            frameImg.onerror = () => {
                showProgress(false);
                showStatus('L·ªói load khung template!', true);
            };
        }

        // Ch·ª©c nƒÉng k√©o
        function setupDrag() {
            stripPreview.classList.add('draggable');
            stripPreview.onmousedown = (e) => {
                if (isFixed) return;
                isDragging = true;
                startX = e.clientX - offsetX;
                startY = e.clientY - offsetY;
            };

            document.onmousemove = (e) => {
                if (!isDragging || isFixed) return;
                offsetX = e.clientX - startX;
                offsetY = e.clientY - startY;
                regenerateStrip(); // T√°i t·∫°o preview v·ªõi v·ªã tr√≠ m·ªõi
            };

            document.onmouseup = () => {
                isDragging = false;
            };
        }

        // T√°i t·∫°o strip khi k√©o
        function regenerateStrip() {
            const frameImg = new Image();
            frameImg.crossOrigin = 'anonymous';
            frameImg.src = currentFrameObj.url;

            frameImg.onload = () => {
                const canvas = createStripCanvas(frameImg, currentFrameObj.paddingTop, currentFrameObj.paddingBottom, currentFrameObj.gap, offsetX, offsetY);
                stripPreview.src = canvas.toDataURL('image/png', 1.0);
            };
        }

        // C·ªë ƒë·ªãnh v·ªã tr√≠
        function fixPosition() {
            isFixed = true;
            adjustControls.style.display = 'none';
            showStatus('V·ªã tr√≠ ƒë√£ c·ªë ƒë·ªãnh! B√¢y gi·ªù t·∫£i t·∫•t c·∫£ s·∫Ω √°p d·ª•ng v·ªã tr√≠ n√†y cho m·ªçi khung.');
        }

        async function downloadAllFrames() {
            if (userImages.length !== 4) return showStatus('C·∫ßn ƒë·ªß 4 ·∫£nh ƒë·ªÉ t·∫£i t·∫•t c·∫£!', true);

            showProgress(true, 'ƒêang t·∫°o to√†n b·ªô khung... (c√≥ th·ªÉ m·∫•t v√†i gi√¢y)');

            const zip = new JSZip();
            const folder = zip.folder("Photobooth_DaiNamUni");

            userImages.forEach((userImg, idx) => {
                const base64 = userImg.dataURL.split(',')[1];
                folder.file(`Anh_${idx + 1}.jpg`, base64, { base64: true });
            });

            let completed = 0;
            const total = allFrames.length;

            for (const frame of allFrames) {
                try {
                    const frameImg = new Image();
                    frameImg.crossOrigin = 'anonymous';
                    frameImg.src = frame.url;

                    await new Promise((resolve, reject) => {
                        frameImg.onload = resolve;
                        frameImg.onerror = reject;
                    });

                    const canvas = createStripCanvas(frameImg, frame.paddingTop, frame.paddingBottom, frame.gap, offsetX, offsetY);
                    const stripBase64 = canvas.toDataURL('image/png', 1.0).split(',')[1];
                    folder.file(`Strip_${frame.name.replace(/[^a-zA-Z0-9]/g, '_')}.png`, stripBase64, { base64: true });

                    completed++;
                    showProgress(true, `ƒê√£ t·∫°o ${completed}/${total} khung...`);
                } catch (err) {
                    console.warn(`Kh√¥ng t·∫°o ƒë∆∞·ª£c khung ${frame.name}:`, err);
                }
            }

            const content = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.download = `Photobooth_DaiNamUni_TatCaKhung.zip`;
            link.href = URL.createObjectURL(content);
            link.click();

            showProgress(false);
            showStatus(`ƒê√£ t·∫£i to√†n b·ªô ${total} khung + 4 ·∫£nh g·ªëc th√†nh c√¥ng!`);
        }

        function setupReveal() {
            const observer = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    if (e.isIntersecting) e.target.classList.add('visible');
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragging'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragging'));
            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/')).slice(0, 4);
                if (files.length > 0) {
                    const dt = new DataTransfer();
                    files.forEach(f => dt.items.add(f));
                    fileInput.files = dt.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });

            setupReveal();
        });
    </script>
    
    <!-- Photobooth Menu (Embedded Version) -->
<style>
    body {
        font-family: 'Poppins', sans-serif;
        overflow-x: hidden;
    }
    .bubble {
        position: absolute;
        bottom: -100px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        animation: rise 12s infinite ease-in;
        filter: blur(0.5px);
        pointer-events: none;
        z-index: 1;
    }
    @keyframes rise {
        0% { transform: translateY(0) scale(1); opacity: 1; }
        100% { transform: translateY(-120vh) scale(1.8); opacity: 0; }
    }

    #openMenu {
        position: fixed;
        bottom: 25px;
        left: 25px;
        background: #ffffffee;
        backdrop-filter: blur(10px);
        padding: 14px 22px;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        font-weight: 600;
        cursor: pointer;
        z-index: 9999;
        transition: 0.3s;
        color: #111; /* ch·ªØ ƒë·∫≠m h∆°n */
    }
    #openMenu:hover { transform: scale(1.06); }

    #menuModal {
        position: fixed;
        inset: 0;
        display: none;
        justify-content: center;
        align-items: center;
        background: rgba(0,0,0,0.25);
        backdrop-filter: blur(5px);
        z-index: 10000;
    }

    .menu-box {
        width: 90%;
        max-width: 450px;
        background: #ffffffdd;
        backdrop-filter: blur(25px);
        padding: 25px;
        border-radius: 25px;
        box-shadow: 0 10px 35px rgba(0,0,0,0.15);
        animation: popUp 0.35s ease;
        text-align: center;
        z-index: 10001;
    }
    @keyframes popUp {
        0% { transform: scale(0.85); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .menu-title {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #1e2f4f; /* ƒë·∫≠m h∆°n cho d·ªÖ nh√¨n */
        letter-spacing: 0.5px;
    }

    .price-card {
        background: #ffffff;
        padding: 12px 15px;
        border-radius: 15px;
        margin-top: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        font-size: 17px;
        font-weight: 500;
        color: #222; /* tƒÉng ƒë·ªô ƒë·∫≠m ch·ªØ */
    }

    #closeMenu {
        margin-top: 15px;
        padding: 10px 20px;
        background: #2a4c7f;
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        transition: 0.25s;
        font-weight: 600;
    }
    #closeMenu:hover { transform: scale(1.05); }
</style>

<script>
for (let i = 0; i < 22; i++) {
    let b = document.createElement("div");
    let size = Math.random()*60 + 20;
    b.classList.add("bubble");
    b.style.width = size + "px";
    b.style.height = size + "px";
    b.style.left = Math.random()*100 + "vw";
    b.style.animationDelay = Math.random()*5 + "s";
    document.body.appendChild(b);
}
</script>

<div id="openMenu">üì∏ Menu Photobooth</div>

<div id="menuModal">
    <div class="menu-box">
        <div class="menu-content">
            <div class="menu-left">
                <div class="menu-title">B·∫£ng Gi√° ·∫¢nh Th∆∞·ªùng</div>
                <div class="price-card">1 t·∫•m (file m·ªÅm): <b>5.000ƒë</b></div>
                <div class="price-card">5 t·∫•m (file m·ªÅm): <b>15.000ƒë</b></div>
                <div class="price-card">35 t·∫•m (b·∫£n m·ªÅm): <b>150.000ƒë</b></div>
                <div class="price-card">35 t·∫•m (b·∫£n in) [6 t·∫•m A4]: <b>200.000ƒë</b></div>
                <div class="price-card">Ph·ª• ph√≠ in ·∫£nh: <b>+20.000ƒë/t·∫•m</b></div><br>

                <div class="menu-title">B·∫£ng Gi√° Photobooth</div>
                <div class="price-card">1 t·∫•m (file m·ªÅm): <b>10.000ƒë</b></div>
                <div class="price-card">5 t·∫•m (file m·ªÅm ‚Äì kh√°c ki·ªÉu): <b>35.000ƒë</b></div>
                <div class="price-card">35 t·∫•m (file m·ªÅm): <b>50.000ƒë</b></div>
                <div class="price-card">35 t·∫•m (file m·ªÅm + in) [t·ª´ 4 ·∫£nh g·ªëc]: <b>150.000ƒë</b></div>
                <div class="price-card">Ph·ª• ph√≠ in ·∫£nh: <b>+20.000ƒë/t·∫•m</b></div>

                <button id="closeMenu">ƒê√≥ng</button>
            </div>

            <!-- QR B√äN PH·∫¢I -->
            <div class="menu-right">
                <img src="./qr.png" class="qr-img">
            </div>
        </div>
    </div>
</div>
<Style>
        #menuModal {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .menu-box {
        background: #fff;
        padding: 20px;
        border-radius: 18px;
        width: 90%;
        max-width: 650px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    }

    .menu-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    /* B√™n tr√°i ch·ª©a to√†n b·ªô menu */
    .menu-left {
        width: 65%;
    }

    /* B√™n ph·∫£i ch·ª©a QR */
    .menu-right {
        width: 35%;
        display: flex;
        justify-content: center;
    }

    /* QR ƒë·∫πp h∆°n */
    .qr-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
</Style>


<script>
const modal = document.getElementById("menuModal");
const openBtn = document.getElementById("openMenu");
const closeBtn = document.getElementById("closeMenu");

openBtn.onclick = () => modal.style.display = "flex";
closeBtn.onclick = () => modal.style.display = "none";
modal.onclick = e => { if(e.target === modal) modal.style.display = "none" }
</script>

</body>
</html>